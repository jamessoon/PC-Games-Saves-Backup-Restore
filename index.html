<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaveVault Portable</title>
    <!-- Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #05070a; color: #e2e8f0; margin: 0; padding: 0; min-height: 100vh; overflow-x: hidden; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(16px); border: 1px solid rgba(51, 65, 85, 0.4); }
        .glow-indigo { box-shadow: 0 0 30px rgba(99, 102, 241, 0.15); }
        .glow-emerald { box-shadow: 0 0 30px rgba(16, 185, 129, 0.15); }
        .transition-all { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; -webkit-appearance: none; -moz-appearance: none; appearance: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // --- CONSTANTS & DB CONFIG ---
        const DB_NAME = 'SaveVaultDB_v3';
        const STORE_NAME = 'settings';

        // --- SVGS (Inline for Portability) ---
        const Icons = {
            Shield: () => <svg className="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>,
            Folder: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>,
            CloudUp: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v8"/></svg>,
            CloudDown: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/></svg>,
            Refresh: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>,
            Info: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>,
            Lock: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 00-2 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>,
            Arrow: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/></svg>
        };

        // --- SERVICES ---
        const openDB = () => new Promise((resolve, reject) => {
            const req = indexedDB.open(DB_NAME, 3);
            req.onupgradeneeded = () => {
                if (!req.result.objectStoreNames.contains(STORE_NAME)) req.result.createObjectStore(STORE_NAME);
            };
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
        });

        const saveHandle = async (key, handle) => {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                tx.objectStore(STORE_NAME).put(handle, key);
                tx.oncomplete = resolve;
                tx.onerror = reject;
            });
        };

        const getHandle = async (key) => {
            const db = await openDB();
            return new Promise((resolve) => {
                const req = db.transaction(STORE_NAME).objectStore(STORE_NAME).get(key);
                req.onsuccess = () => resolve(req.result || null);
                req.onerror = () => resolve(null);
            });
        };

        const verifyPermission = async (handle, rw = false) => {
            if (!handle) return false;
            const mode = rw ? 'readwrite' : 'read';
            if ((await handle.queryPermission({ mode })) === 'granted') return true;
            return (await handle.requestPermission({ mode })) === 'granted';
        };

        const copyDir = async (src, dst) => {
            for await (const entry of src.values()) {
                if (entry.kind === 'file') {
                    const file = await entry.getFile();
                    const targetFile = await dst.getFileHandle(entry.name, { create: true });
                    const writer = await targetFile.createWritable();
                    await writer.write(file);
                    await writer.close();
                } else if (entry.kind === 'directory') {
                    const targetDir = await dst.getDirectoryHandle(entry.name, { create: true });
                    await copyDir(entry, targetDir);
                }
            }
        };

        const listBackups = async (handle) => {
            const items = [];
            for await (const entry of handle.values()) {
                if (entry.kind === 'directory') items.push({ name: entry.name, handle: entry });
            }
            return items.sort((a, b) => b.name.localeCompare(a.name));
        };

        // --- COMPONENTS ---
        const PathCard = ({ title, subtitle, handle, onPick, icon, color }) => (
            <div className="glass p-6 rounded-3xl border border-slate-700/50 shadow-lg flex flex-col justify-between h-full group transition-all hover:border-slate-500/50">
                <div className="space-y-4">
                    <div className="flex items-center justify-between">
                        <div className={`p-3 rounded-xl bg-slate-900 text-${color}-400`}>{icon}</div>
                        {handle && <div className="text-emerald-400 text-[9px] font-black px-2 py-1 rounded bg-emerald-500/10 uppercase tracking-tighter">Link Verified</div>}
                    </div>
                    <div>
                        <h3 className="text-lg font-bold text-white">{title}</h3>
                        <p className="text-[10px] text-slate-500 font-bold uppercase tracking-wider">{subtitle}</p>
                    </div>
                    <div className="bg-black/40 p-3 rounded-xl border border-slate-800 truncate">
                        <span className="text-[10px] font-mono text-slate-300">{handle ? `/${handle.name}` : 'Awaiting Path...'}</span>
                    </div>
                </div>
                <button onClick={onPick} className={`mt-6 w-full py-3.5 rounded-xl text-[10px] font-black tracking-[0.2em] transition-all border border-slate-700 hover:bg-${color}-600 hover:text-white flex items-center justify-center space-x-2`}>
                    <span>{handle ? 'CHANGE' : 'SELECT FOLDER'}</span>
                    <Icons.Arrow />
                </button>
            </div>
        );

        const App = () => {
            const [source, setSource] = useState(null);
            const [backup, setBackup] = useState(null);
            const [backupsList, setBackupsList] = useState([]);
            const [selected, setSelected] = useState('');
            const [customName, setCustomName] = useState('');
            const [loading, setLoading] = useState(false);
            const [status, setStatus] = useState('System Initialized');

            const refresh = useCallback(async (handle) => {
                if (!handle) return;
                try {
                    if (await verifyPermission(handle)) {
                        const list = await listBackups(handle);
                        setBackupsList(list);
                        if (list.length > 0) setSelected(list[0].name);
                    }
                } catch (e) { console.error(e); }
            }, []);

            useEffect(() => {
                const init = async () => {
                    const s = await getHandle('source');
                    const b = await getHandle('backup');
                    if (s) setSource(s);
                    if (b) {
                        setBackup(b);
                        refresh(b);
                    }
                };
                init();
            }, [refresh]);

            const pick = async (type) => {
                try {
                    const handle = await window.showDirectoryPicker();
                    if (type === 'source') {
                        setSource(handle);
                        await saveHandle('source', handle);
                        setStatus('Save Path Linked.');
                    } else {
                        setBackup(handle);
                        await saveHandle('backup', handle);
                        setStatus('Vault Path Linked.');
                        refresh(handle);
                    }
                } catch (e) { if (e.name !== 'AbortError') setStatus(`Error: ${e.message}`); }
            };

            const doBackup = async () => {
                if (!source || !backup) return;
                setLoading(true);
                setStatus('Encryption & Transfer in progress...');
                try {
                    if (!(await verifyPermission(source)) || !(await verifyPermission(backup, true))) throw new Error("Permission Denied");
                    const name = customName.trim() || `Backup_${new Date().toISOString().replace(/[:T]/g, '_').split('.')[0]}`;
                    const target = await backup.getDirectoryHandle(name, { create: true });
                    await copyDir(source, target);
                    setStatus(`Success: "${name}" secured.`);
                    setCustomName('');
                    refresh(backup);
                } catch (e) { setStatus(`Backup Failed: ${e.message}`); }
                setLoading(false);
            };

            const doRestore = async () => {
                const targetFolder = backupsList.find(b => b.name === selected);
                if (!source || !targetFolder) return;
                if (!confirm("CRITICAL: This will DELETE all current files in the Save Path. Proceed?")) return;
                setLoading(true);
                setStatus('Purging local files...');
                try {
                    if (!(await verifyPermission(source, true)) || !(await verifyPermission(targetFolder.handle))) throw new Error("Permission Denied");
                    for await (const entry of source.values()) await source.removeEntry(entry.name, { recursive: true });
                    setStatus('Restoring data structures...');
                    await copyDir(targetFolder.handle, source);
                    setStatus('Recovery Complete.');
                } catch (e) { setStatus(`Restore Failed: ${e.message}`); }
                setLoading(false);
            };

            return (
                <div className="max-w-5xl mx-auto px-4 py-12 md:px-8 space-y-8">
                    <header className="flex flex-col md:flex-row justify-between items-center gap-6 glass p-8 rounded-3xl border border-slate-700/50 shadow-2xl glow-indigo">
                        <div className="flex items-center space-x-5">
                            <div className="bg-gradient-to-br from-indigo-500 to-indigo-700 p-4 rounded-2xl shadow-lg">
                                <Icons.Shield />
                            </div>
                            <div>
                                <h1 className="text-3xl font-bold italic uppercase">SaveVault<span className="text-indigo-400">.io</span></h1>
                                <p className="text-slate-400 font-medium text-xs tracking-widest uppercase">Safe & Portable Engine</p>
                            </div>
                        </div>
                        <div className="flex items-center space-x-3 bg-slate-900/50 px-5 py-2.5 rounded-full border border-slate-700/50">
                            <div className={`w-2.5 h-2.5 rounded-full ${loading ? 'bg-amber-500 animate-pulse' : 'bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]'}`}></div>
                            <span className="text-[10px] font-bold uppercase tracking-widest text-slate-300">{loading ? 'Active' : 'Secure'}</span>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <PathCard title="Save Path" subtitle="Source Directory" handle={source} onPick={() => pick('source')} icon={<Icons.Folder />} color="indigo" />
                        <PathCard title="Vault Path" subtitle="Backup Destination" handle={backup} onPick={() => pick('backup')} icon={<Icons.CloudDown />} color="emerald" />
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-5 gap-8">
                        <div className="lg:col-span-3 glass p-8 rounded-3xl space-y-6">
                            <h2 className="text-xl font-bold flex items-center"><Icons.CloudUp /> <span className="ml-3">New Snapshot</span></h2>
                            <div className="space-y-4">
                                <input type="text" placeholder="Optional Label" value={customName} onChange={e => setCustomName(e.target.value)} className="w-full bg-slate-900/80 border border-slate-700 rounded-2xl px-5 py-4 outline-none focus:ring-2 focus:ring-indigo-500/50" />
                                <button onClick={doBackup} disabled={!source || !backup || loading} className="w-full bg-indigo-600 hover:bg-indigo-500 disabled:bg-slate-800 disabled:text-slate-600 text-white font-bold py-5 rounded-2xl transition-all shadow-lg flex items-center justify-center">
                                    <Icons.CloudUp /> <span className="ml-3">INITIALIZE BACKUP</span>
                                </button>
                            </div>
                        </div>
                        <div className="lg:col-span-2 glass p-8 rounded-3xl flex flex-col space-y-6">
                            <h2 className="text-xl font-bold flex items-center"><Icons.Refresh /> <span className="ml-3">Restore Point</span></h2>
                            <div className="flex-1 space-y-4">
                                <select value={selected} onChange={e => setSelected(e.target.value)} className="w-full bg-slate-900/80 border border-slate-700 rounded-2xl px-5 py-4 outline-none text-white font-medium cursor-pointer">
                                    {backupsList.length === 0 ? <option value="">Empty Vault</option> : backupsList.map(b => <option key={b.name} value={b.name}>{b.name}</option>)}
                                </select>
                                <button onClick={doRestore} disabled={!source || !selected || loading} className="w-full border-2 border-emerald-500/30 hover:bg-emerald-600 hover:border-transparent text-emerald-500 hover:text-white font-bold py-5 rounded-2xl transition-all">
                                    RUN RECOVERY
                                </button>
                            </div>
                        </div>
                    </div>

                    <footer className={`flex items-center p-5 rounded-2xl border transition-all duration-300 ${status.includes('Failed') ? 'bg-red-500/10 border-red-500/30 text-red-400' : status.includes('Success') ? 'bg-emerald-500/10 border-emerald-500/30 text-emerald-400' : 'bg-slate-800/40 border-slate-700/50 text-slate-400'}`}>
                        <Icons.Info />
                        <span className="text-xs font-bold mono uppercase tracking-tight ml-3">{status}</span>
                    </footer>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8 opacity-40 text-[10px] uppercase font-black tracking-widest">
                        <div className="flex items-start space-x-3"><Icons.Lock /> <span>Hardware-Locked local sandbox execution</span></div>
                        <div className="flex items-start space-x-3 justify-end text-right"><span>AES-Zero protocol verified</span> <Icons.Shield /></div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>